{% extends "layout.html" %}

{% block content %}
    <h1>Palmarès des ventes</h1>
	<div>
    <label for="search">Rechercher un produit:</label>
    <input type="text" id="search" placeholder="Rechercher par code article, EAN ou titre...">
    <div id="search-results"></div>

    </div>

<script>
    const searchInput = document.getElementById('search');
    const resultsDiv = document.getElementById('search-results');

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim();
        if (query.length > 0) {
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la requête');
                    }
                    return response.json();
                })
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<p>Aucun résultat trouvé</p>';
                    } else {
                        data.forEach(product => {
                            const productDiv = document.createElement('div');
                            productDiv.innerText = `${product.nom_produit} (${product.code_article})`;
                            productDiv.addEventListener('click', () => {
                                window.location.href = `/product/${product.code_article}/details`;
                            });
                            resultsDiv.appendChild(productDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error('Erreur :', error);
                });
        } else {
            resultsDiv.innerHTML = '';
        }
    });
</script>

	
    <table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>
                <a href="/?order_by=code_article ASC">Code Article ↑</a> | 
                <a href="/?order_by=code_article DESC">↓</a>
            </th>
            <th>
                <a href="/?order_by=nom_produit ASC">Nom du Produit ↑</a> | 
                <a href="/?order_by=nom_produit DESC">↓</a>
            </th>
            <th>
                <a href="/?order_by=quantite_stock ASC">Stock ↑</a> | 
                <a href="/?order_by=quantite_stock DESC">↓</a>
            </th>
            <th>Alerte</th>
            <th>
                <a href="/?order_by=vente_2025 ASC">Vente 2025 ↑</a> | 
                <a href="/?order_by=vente_2025 DESC">↓</a>
            </th>
            <th>
                <a href="/?order_by=vente_2024 ASC">Vente 2024 ↑</a> | 
                <a href="/?order_by=vente_2024 DESC">↓</a>
            </th>
            <th>
                <a href="/?order_by=vente_2023 ASC">Vente 2023 ↑</a> | 
                <a href="/?order_by=vente_2023 DESC">↓</a>
            </th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for row in tables %}
        <tr>
            <td>
                <a href="/product/{{ row['code_article'] }}/details">{{ row.code_article }}</a>
            </td>
            <td>{{ row.nom_produit }}</td>
            <td>{{ row.quantite_stock }}</td>
            <td class="
                {% if row.alerte == 'Recommander' %}alert-red{% endif %}
                {% if row.alerte == 'OK' %}alert-green{% endif %}
            ">
                {{ row.alerte }}
            </td>
            <td class="{% if row.vente_2025 > row.vente_2024 %}green-background{% elif row.vente_2025 < row.vente_2024 %}red-background{% endif %}">
                {{ row.vente_2025 }}
            </td>
            <td class="{% if row.vente_2024 > row.vente_2023 %}green-background{% elif row.vente_2024 < row.vente_2023 %}red-background{% endif %}">
                {{ row.vente_2024 }}
            </td>
            <td>{{ row.vente_2023 }}</td>
            <td>
                <a href="/product/{{ row['code_article'] }}/monthly_sales">Voir Ventes Mensuelles par pharmacie</a><br>
                <a href="/product/{{ row['code_article'] }}/monthly_sales_product">Voir Ventes Mensuelles</a><br>
                <a href="/add_product_form?code_article={{ row.code_article }}">Ajouter Détails</a><br>
                <a href="/product/{{ row.code_article }}">Voir Ventes Mensuelles par représentant</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}
